================================================================================
ğŸ§  ENHANCED ARCHITECTURE ANALYSIS V3.1
================================================================================

Fixes from v3:
  âœ“ Fixed pathlib.relative_to â†’ py_file.as_posix()
  âœ“ file_relative before try/except (no NameError)
  âœ“ Full module labels for decorator matching
  âœ“ Merged all_decorated set for FPs
================================================================================

ğŸ“‚ Loading dependency graph...

ğŸ“¦ LOADED:
  - 79 modules
  - 289 functions
  - 50 classes

================================================================================
ğŸ” SCANNING FOR DECORATORS AND SPECIAL PATTERNS (v3.1 FIXED)
================================================================================

ğŸ”¬ Scanning 61 Python files for decorators...

ğŸ” DEBUG - Decorators found: 66
  âœ“ validate_x_max @field_validator in arz_model/config/network_simulation_config.py
  âœ“ validate_x_max @classmethod in arz_model/config/network_simulation_config.py
  âœ“ validate_N @field_validator in arz_model/config/network_simulation_config.py
  âœ“ validate_N @classmethod in arz_model/config/network_simulation_config.py
  âœ“ validate_type @field_validator in arz_model/config/network_simulation_config.py
  âœ“ validate_type @classmethod in arz_model/config/network_simulation_config.py
  âœ“ validate_position @field_validator in arz_model/config/network_simulation_config.py
  âœ“ validate_position @classmethod in arz_model/config/network_simulation_config.py
  âœ“ validate_traffic_light_config @field_validator in arz_model/config/network_simulation_config.py
  âœ“ validate_traffic_light_config @classmethod in arz_model/config/network_simulation_config.py

ğŸ” DEBUG - Pytest tests found: 25
  âœ“ test_cuda_availability_check in arz_model/tests/test_gpu_memory_pool.py
  âœ“ test_valid_initialization in arz_model/tests/test_gpu_memory_pool.py
  âœ“ test_segment_mismatch_validation in arz_model/tests/test_gpu_memory_pool.py
  âœ“ test_streams_configuration in arz_model/tests/test_gpu_memory_pool.py
  âœ“ test_segment_state_access in arz_model/tests/test_gpu_memory_pool.py
  âœ“ test_road_quality_access in arz_model/tests/test_gpu_memory_pool.py
  âœ“ test_stream_access in arz_model/tests/test_gpu_memory_pool.py
  âœ“ test_state_initialization_full_array in arz_model/tests/test_gpu_memory_pool.py
  âœ“ test_state_initialization_physical_only in arz_model/tests/test_gpu_memory_pool.py
  âœ“ test_invalid_initialization in arz_model/tests/test_gpu_memory_pool.py

ğŸ” DEBUG - Main calls found: 59
  âœ“ main called from main in arz_model/main_network_builder.py
  âœ“ benchmark_simulation_performance called from main in arz_model/benchmarks/benchmark_gpu_only.py
  âœ“ profile_memory_usage called from main in arz_model/benchmarks/benchmark_gpu_only.py
  âœ“ BoundaryConditionsConfig called from main in arz_model/config/bc_config.py
  âœ“ print called from main in arz_model/config/bc_config.py
  âœ“ BoundaryConditionsConfig called from main in arz_model/config/bc_config.py
  âœ“ print called from main in arz_model/config/bc_config.py
  âœ“ BoundaryConditionsConfig called from main in arz_model/config/bc_config.py
  âœ“ print called from main in arz_model/config/bc_config.py
  âœ“ InflowBC called from main in arz_model/config/bc_config.py

ğŸ“Š DECORATOR DETECTION RESULTS:
  - 57 functions with decorators
  - 25 pytest test functions (test_*)
  - 0 pytest fixtures (@pytest.fixture)
  - 11 Pydantic validators (@field_validator)
  - 0 property methods (@property)
  - 11 class methods (@classmethod)
  - 1 static methods (@staticmethod)
  - 27 main entry point calls (if __name__ == '__main__')

================================================================================
ğŸ”— BUILDING ENHANCED CALL GRAPH
================================================================================
Total dependencies: 251
  - 164 functions that call others
  - 115 functions that are called

================================================================================
âš ï¸  ENHANCED DEAD CODE DETECTION
================================================================================

ğŸ“Š RESULTS:
  - 74 CONFIRMED DEAD functions
  - 77 SUSPECTED FALSE POSITIVES
  - Total analyzed: 224

================================================================================
ğŸš¨ SUSPECTED FALSE POSITIVES (DO NOT DELETE)
================================================================================

These functions appear 'dead' but are likely called via:
  - Decorators (@pytest.fixture, @field_validator, @property)
  - Indirect class calls (e.g., SSP_RK3_GPU().integrate())
  - Main entry points (if __name__ == '__main__')
  - Public API conventions (run, get_*, set_*)
================================================================================

ğŸ” Decorated/special function (pytest/field_validator/property/etc.) (37 functions)
--------------------------------------------------------------------------------

   ğŸ“„ arz_model/benchmarks/benchmark_gpu_only.py
      âœ“ benchmark_simulation_performance
      âœ“ profile_memory_usage

   ğŸ“„ arz_model/config/network_simulation_config.py
      âœ“ validate_coupling_type
      âœ“ validate_segments
      âœ“ validate_type
      âœ“ validate_x_max

   ğŸ“„ arz_model/config/time_config.py
      âœ“ output_dt_must_be_less_than_t_final

   ğŸ“„ arz_model/core/physics.py
      âœ“ _calculate_supply_flux_cuda
      âœ“ _invert_flux_function_cuda
      âœ“ calculate_equilibrium_speed_gpu
      âœ“ calculate_relaxation_time_gpu
      âœ“ calculate_source_term_gpu

   ğŸ“„ arz_model/numerics/gpu/network_coupling_gpu.py
      âœ“ apply_ghost_cell_fluxes
      âœ“ apply_inflow_boundary_condition
      âœ“ apply_outflow_boundary_condition

   ğŸ“„ arz_model/numerics/reconstruction/converter.py
      âœ“ conserved_to_primitives_arr
      âœ“ primitives_to_conserved_arr

   ğŸ“„ arz_model/numerics/reconstruction/weno_gpu.py
      âœ“ _central_upwind_flux_gpu_device
      âœ“ _primitives_to_conserved_gpu_device

   ğŸ“„ arz_model/numerics/riemann_solvers.py
      âœ“ _central_upwind_flux_cuda

   ğŸ“„ arz_model/road_network/models.py
      âœ“ must_be_positive

   ğŸ“„ arz_model/tests/test_gpu_memory_pool.py
      âœ“ test_asynchronous_checkpoint
      âœ“ test_checkpoint_invalid_segment
      âœ“ test_destructor_cleanup
      âœ“ test_invalid_initialization
      âœ“ test_memory_persistence
      âœ“ test_road_quality_access
      âœ“ test_segment_mismatch_validation
      âœ“ test_segment_state_access
      âœ“ test_state_initialization_full_array
      âœ“ test_state_initialization_physical_only
      âœ“ test_stream_access
      âœ“ test_string_representation
      âœ“ test_synchronous_checkpoint

   ğŸ“„ arz_model/tests/test_gpu_only_integration.py
      âœ“ test_gpu_required_error
      âœ“ test_mass_conservation_gpu
      âœ“ test_simulation_runs_end_to_end_on_gpu

ğŸ” GPU kernel (called indirectly via classes) (18 functions)
--------------------------------------------------------------------------------

   ğŸ“„ arz_model/numerics/cfl.py
      âœ“ _calculate_max_wavespeed_kernel

   ğŸ“„ arz_model/numerics/gpu/network_coupling_gpu.py
      âœ“ network_coupling_kernel

   ğŸ“„ arz_model/numerics/gpu/ssp_rk3_cuda.py
      âœ“ compute_flux_divergence_kernel
      âœ“ ssp_rk3_stage1_kernel
      âœ“ ssp_rk3_stage2_kernel
      âœ“ ssp_rk3_stage3_kernel

   ğŸ“„ arz_model/numerics/gpu/utils.py
      âœ“ profile_gpu_kernel

   ğŸ“„ arz_model/numerics/gpu/weno_cuda.py
      âœ“ apply_boundary_conditions_kernel
      âœ“ weno5_reconstruction_optimized_kernel

   ğŸ“„ arz_model/numerics/reconstruction/converter.py
      âœ“ conserved_to_primitives_kernel
      âœ“ primitives_to_conserved_kernel

   ğŸ“„ arz_model/numerics/reconstruction/weno_gpu.py
      âœ“ _compute_flux_divergence_weno_kernel
      âœ“ _compute_weno_fluxes_kernel
      âœ“ apply_weno_boundary_conditions_kernel

   ğŸ“„ arz_model/numerics/riemann_solvers.py
      âœ“ central_upwind_flux_cuda_kernel

   ğŸ“„ arz_model/numerics/time_integration.py
      âœ“ _apply_bounds_kernel
      âœ“ _ode_step_kernel
      âœ“ ssp_rk3_stage_1_kernel

ğŸ” Public API method (run/get/set/execute/etc.) (22 functions)
--------------------------------------------------------------------------------

   ğŸ“„ arz_model/core/node_solver_gpu.py
      âœ“ create_gpu_node_solver_for_network

   ğŸ“„ arz_model/core/parameter_manager.py
      âœ“ get_all
      âœ“ set_local
      âœ“ set_local_dict

   ğŸ“„ arz_model/network/link.py
      âœ“ get_coupling_strength

   ğŸ“„ arz_model/network/network_grid.py
      âœ“ initialize

   ğŸ“„ arz_model/network/network_simulator.py
      âœ“ _build_network_from_config_simple
      âœ“ _build_state
      âœ“ get_metrics
      âœ“ set_signal

   ğŸ“„ arz_model/network/topology.py
      âœ“ get_network_diameter

   ğŸ“„ arz_model/numerics/gpu/memory_pool.py
      âœ“ get_road_quality_array

   ğŸ“„ arz_model/numerics/gpu/utils.py
      âœ“ get_optimal_block_size

   ğŸ“„ arz_model/numerics/reconstruction/weno_gpu.py
      âœ“ _create_weno_flux_kernel

   ğŸ“„ arz_model/numerics/riemann_solvers.py
      âœ“ set_current_time

   ğŸ“„ arz_model/road_network/parser.py
      âœ“ _get_safe_value

   ğŸ“„ arz_model/simulation/execution/network_simulator.py
      âœ“ _initialize_gpu_coupling
      âœ“ _initialize_gpu_pool

   ğŸ“„ arz_model/simulation/runner.py
      âœ“ _create_initial_state
      âœ“ _create_legacy_params_from_config
      âœ“ _initialize_boundary_conditions
      âœ“ _initialize_network

================================================================================
âŒ CONFIRMED DEAD FUNCTIONS (SAFE TO DELETE)
================================================================================

These functions are NOT called anywhere and have no decorators.
They are likely legacy code that can be safely removed.
================================================================================

ğŸ“Š Total: 74 functions across 28 modules


   ğŸ“„ arz_model/core/node_solver_gpu.py (3 dead functions)
      âŒ apply_network_coupling_gpu_native
      âŒ setup_network_topology
      âŒ setup_physics_parameters

   ğŸ“„ arz_model/core/parameter_manager.py (3 dead functions)
      âŒ has_local
      âŒ list_segments_with_overrides
      âŒ summary

   ğŸ“„ arz_model/core/parameters.py (1 dead functions)
      âŒ _validate_parameters

   ğŸ“„ arz_model/io/data_manager.py (3 dead functions)
      âŒ load_road_quality_file
      âŒ save_mass_data
      âŒ save_simulation_data

   ğŸ“„ arz_model/network/link.py (1 dead functions)
      âŒ apply_behavioral_coupling

   ğŸ“„ arz_model/network/network_grid.py (3 dead functions)
      âŒ _apply_network_boundary_conditions
      âŒ _prepare_junction_info
      âŒ add_link

   ğŸ“„ arz_model/network/network_simulator.py (1 dead functions)
      âŒ _apply_initial_conditions

   ğŸ“„ arz_model/network/topology.py (3 dead functions)
      âŒ compute_shortest_path
      âŒ find_downstream_segments
      âŒ find_upstream_segments

   ğŸ“„ arz_model/numerics/boundary_conditions.py (1 dead functions)
      âŒ apply_boundary_conditions

   ğŸ“„ arz_model/numerics/cfl.py (3 dead functions)
      âŒ calculate_cfl_dt
      âŒ cfl_condition
      âŒ cfl_condition_gpu_native

   ğŸ“„ arz_model/numerics/gpu/memory_pool.py (2 dead functions)
      âŒ _allocate_all_arrays
      âŒ release_temp_array

   ğŸ“„ arz_model/numerics/gpu/network_coupling_gpu.py (1 dead functions)
      âŒ _prepare_gpu_topology

   ğŸ“„ arz_model/numerics/gpu/ssp_rk3_cuda.py (2 dead functions)
      âŒ cleanup
      âŒ integrate_step

   ğŸ“„ arz_model/numerics/gpu/utils.py (3 dead functions)
      âŒ check_cuda_availability
      âŒ cleanup
      âŒ validate_gpu_vs_cpu

   ğŸ“„ arz_model/numerics/gpu/weno_cuda.py (2 dead functions)
      âŒ reconstruct_weno5_gpu
      âŒ reconstruct_weno5_gpu_optimized

   ğŸ“„ arz_model/numerics/logging_utils.py (1 dead functions)
      âŒ should_log

   ğŸ“„ arz_model/numerics/reconstruction/converter.py (2 dead functions)
      âŒ conserved_to_primitives_arr_gpu
      âŒ primitives_to_conserved_arr_gpu

   ğŸ“„ arz_model/numerics/reconstruction/weno_gpu.py (1 dead functions)
      âŒ calculate_spatial_discretization_weno_gpu

   ğŸ“„ arz_model/numerics/riemann_solvers.py (2 dead functions)
      âŒ central_upwind_flux_gpu
      âŒ godunov_flux_upwind

   ğŸ“„ arz_model/numerics/time_integration.py (15 dead functions)
      âŒ _ode_rhs
      âŒ _ode_rhs_corrected
      âŒ apply_inflow_bc_manually
      âŒ apply_physical_state_bounds
      âŒ apply_physical_state_bounds_gpu
      âŒ calculate_spatial_discretization_godunov
      âŒ calculate_spatial_discretization_weno
      âŒ check_cfl_condition
      âŒ compute_boundary_correction
      âŒ compute_boundary_weight
      âŒ primitives_to_conserved_single
      âŒ solve_hyperbolic_step_ssp_rk3_gpu_native
      âŒ solve_ode_step_cpu
      âŒ solve_ode_step_gpu
      âŒ strang_splitting_step

   ğŸ“„ arz_model/simulation/execution/network_simulator.py (1 dead functions)
      âŒ _log_state

   ğŸ“„ arz_model/simulation/initial_conditions.py (1 dead functions)
      âŒ uniform_initial_condition

   ğŸ“„ arz_model/simulation/runner.py (8 dead functions)
      âŒ _common_initialization
      âŒ _convert_bc_to_legacy
      âŒ _convert_ic_to_legacy
      âŒ _init_from_network_grid
      âŒ _update_bc_from_schedule
      âŒ animate_results
      âŒ save_results
      âŒ step

   ğŸ“„ arz_model/simulation/state/state_manager.py (3 dead functions)
      âŒ advance_time
      âŒ load_checkpoint_from_disk
      âŒ save_checkpoint_to_disk

   ğŸ“„ arz_model/tests/test_gpu_memory_pool.py (1 dead functions)
      âŒ simple_config

   ğŸ“„ arz_model/visualization/network_visualizer.py (2 dead functions)
      âŒ _draw_base_network
      âŒ update_plot

   ğŸ“„ arz_model/visualization/plotting.py (3 dead functions)
      âŒ plot_convergence_loglog
      âŒ plot_profiles
      âŒ plot_spacetime

   ğŸ“„ arz_model/visualization/uxsim_adapter.py (2 dead functions)
      âŒ update_frame
      âŒ visualize_snapshot

================================================================================
ğŸ” ADDITIONAL INSIGHTS
================================================================================

1. ENTRY POINTS (functions likely called externally):
--------------------------------------------------------------------------------
  run                                      in arz_model/simulation/execution/network_simulator.py - called by 4 functions
  main                                     in arz_model/main_network_builder.py        - called by 1 functions
  main                                     in arz_model/main_network_simulation.py     - called by 1 functions
  run                                      in arz_model/simulation/runner.py           - called by 1 functions
  test_simulation_runs_end_to_end_on_gpu   in arz_model/tests/test_gpu_only_integration.py - called by 0 functions


2. HUB FUNCTIONS (called by many others):
--------------------------------------------------------------------------------
  cleanup                                  (arz_model/core/node_solver_gpu.py       ) - called by 20 functions
  __init__                                 (arz_model/core/node_solver_gpu.py       ) - called by 17 functions
  get                                      (arz_model/core/parameter_manager.py     ) - called by 13 functions
  __repr__                                 (arz_model/config/physics_config.py      ) - called by 12 functions
  from_config                              (arz_model/network/network_grid.py       ) - called by 11 functions
  checkpoint_to_cpu                        (arz_model/numerics/gpu/memory_pool.py   ) - called by 8 functions
  initialize_segment_state                 (arz_model/numerics/gpu/memory_pool.py   ) - called by 7 functions
  get_boundary_states                      (arz_model/network/node.py               ) - called by 5 functions
  get_segment_state                        (arz_model/numerics/gpu/memory_pool.py   ) - called by 5 functions
  create_test_config                       (arz_model/tests/test_gpu_only_integration.py) - called by 5 functions
  step                                     (arz_model/network/network_grid.py       ) - called by 4 functions
  get_outgoing_capacities                  (arz_model/network/node.py               ) - called by 4 functions
  _get_memory_delta                        (arz_model/numerics/gpu/memory_pool.py   ) - called by 4 functions
  _get_gpu_memory_usage                    (arz_model/numerics/gpu/memory_pool.py   ) - called by 4 functions
  get_memory_stats                         (arz_model/numerics/gpu/memory_pool.py   ) - called by 4 functions
  calculate_spatial_discretization_weno_gpu_native (arz_model/numerics/reconstruction/weno_gpu.py) - called by 4 functions
  run                                      (arz_model/simulation/execution/network_simulator.py) - called by 4 functions
  get_results                              (arz_model/simulation/runner.py          ) - called by 3 functions
  get_stream                               (arz_model/numerics/gpu/memory_pool.py   ) - called by 3 functions
  _update_plot_from_state                  (arz_model/visualization/network_visualizer.py) - called by 3 functions
  close                                    (arz_model/visualization/network_visualizer.py) - called by 3 functions
  create_benchmark_config                  (arz_model/benchmarks/benchmark_gpu_only.py) - called by 2 functions
  _calculate_physical_velocity_cuda        (arz_model/core/physics.py               ) - called by 2 functions
  _calculate_pressure_derivative_cuda      (arz_model/core/physics.py               ) - called by 2 functions
  __str__                                  (arz_model/core/parameters.py            ) - called by 2 functions
  add_node_from_config                     (arz_model/network/network_grid.py       ) - called by 2 functions
  add_segment                              (arz_model/network/network_grid.py       ) - called by 2 functions
  add_outgoing_segment                     (arz_model/network/node.py               ) - called by 2 functions
  build_graph                              (arz_model/network/topology.py           ) - called by 2 functions
  get_temp_array                           (arz_model/numerics/gpu/memory_pool.py   ) - called by 2 functions

================================================================================
ğŸ“‹ SUMMARY
================================================================================

Architecture Analysis Complete! (v3.1)

Total Functions: 289
  â”œâ”€ Called at least once: 115
  â”œâ”€ Never called (total): 224
  â”‚   â”œâ”€ Confirmed dead: 74
  â”‚   â””â”€ Suspected false positives: 77
  â””â”€ With decorators: 57

Special Functions Detected:
  â”œâ”€ Pytest tests: 25
  â”œâ”€ Pytest fixtures: 0
  â”œâ”€ Pydantic validators: 11
  â”œâ”€ Property methods: 0
  â”œâ”€ Class methods: 11
  â”œâ”€ Static methods: 1
  â””â”€ Main entry points: 27

Recommendations:
  âœ“ DO NOT delete functions in "SUSPECTED FALSE POSITIVES"
  âœ“ SAFE to delete functions in "CONFIRMED DEAD FUNCTIONS"
  âœ“ Review entry points and hub functions for refactoring opportunities

================================================================================
âœ… Analysis saved to: arz_model/architecture_analysis_v3.txt
================================================================================
